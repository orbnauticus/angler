#!/usr/bin/env python3

from angler.core import Manifest, default_manifest
from angler.command import Add
from angler.util import uri, key_value

import argparse
import cmd
import shlex


def single_arg(string):
    values = shlex.split(string)
    if len(values) > 1:
        raise ValueError("Unexpected arguments: {}".format(values[1:]))
    return values[0]


class AnglerShell(cmd.Cmd):
    def __init__(self, manifest):
        super(AnglerShell, self).__init__()
        self.settings = dict()
        self.manifest = manifest
        self.settings['manifest'] = manifest.database
        self.settings['curdir'] = ''
        self.prompt = '{manifest}#{curdir}âŸ«'

    @property
    def prompt(self):
        return self.settings['prompt'].format(**self.settings) + ' '

    @prompt.setter
    def prompt(self, new):
        self.settings['prompt'] = new

    def default(self, line):
        if line == 'EOF':
            print('exit')
            return True
        else:
            return super(AnglerShell, self).default(line)

    def do_exit(self, arg):
        return True

    def do_add(self, arg):
        try:
            add = Add.from_arguments(self.manifest, shlex.split(arg))
        except SystemExit:
            return

        if self.settings['dryrun']:
            print('Would add node', add.uri, add.status)
        else:
            add.run()

    def do_var(self, arg):
        if not arg:
            for key in sorted(self.settings):
                print('{}={!r}'.format(key, self.settings[key]))
            return
        key, successful, value = arg.partition('=')
        if successful:
            self.settings[key.strip()] = single_arg(value)
        else:
            key = arg.strip()
            print('{}={!r}'.format(key, self.settings[key]))

    def do_cd(self, arg):
        self.settings['curdir'] = single_arg(arg)

    def do_ls(self, arg):
        arg = arg or self.settings['curdir']
        if not arg:
            for scheme in self.manifest.plugins:
                print('{}://'.format(scheme))
        else:
            print('Not Implemented!')

    def help_add(self):
        print(Add.help())


if __name__ == '__main__':

    parser = argparse.ArgumentParser()

    parser.add_argument('manifest', nargs='?', default=default_manifest)
    parser.add_argument('-n', '--dryrun', action='store_true')

    args = parser.parse_args()

    manifest = Manifest(args.manifest)

    try:
        shell = AnglerShell(manifest)
        shell.settings['dryrun'] = args.dryrun
        shell.cmdloop()
    except KeyboardInterrupt:
        print()
        exit(0)
