#!/usr/bin/env python3

from angler.core import Manifest, default_manifest, Session, setup
from angler.command import Add, Order
from angler.util import uri, key_value

import argparse
import cmd
import os
import shlex
import sys


def single_arg(string):
    values = shlex.split(string)
    if len(values) > 1:
        raise ValueError("Unexpected arguments: {}".format(values[1:]))
    return values[0]


class AnglerShell(cmd.Cmd):
    def __init__(self, manifest, history='~/.angler_history'):
        super(AnglerShell, self).__init__()
        self.isatty = sys.stdin.isatty()
        self.environment = dict()
        self.manifest = manifest
        self.session = Session(manifest)
        self.environment['manifest'] = manifest.database
        self.environment['curdir'] = ''
        self.prompt = '{manifest}#{curdir}âŸ«'
        self.environment['prompt2'] = '>'
        self.multiline = ''
        self.history = os.path.expanduser(history)
        try:
            import readline
            readline.read_history_file(self.history)
        except FileNotFoundError:
            pass
        except ImportError:
            pass
        else:
            import atexit
            atexit.register(readline.write_history_file, self.history)

    @property
    def prompt(self):
        if not self.isatty:
            return ''
        elif self.multiline:
            return self.environment['prompt2'] + ' '
        else:
            return self.environment['prompt'].format(**self.environment) + ' '

    @prompt.setter
    def prompt(self, new):
        self.environment['prompt'] = new

    def emptyline(self):
        pass

    def parseline(self, line):
        if self.multiline:
            line = '{}\n{}'.format(self.multiline, line)
        self.multiline = ''
        try:
            words = shlex.split(line)
        except ValueError as error:
            if error.args == ('No closing quotation',):
                self.multiline = line
                return None, None, ''
            elif error.args == ('No escaped character',):
                self.multiline = line[:-1]
                return None, None, ''
        if not words:
            return None, None, ''
        cmd, arg = words[0], words[1:]
        return cmd, arg, line

    def default(self, line):
        if line == 'EOF':
            if self.isatty:
                print('exit')
            return self.do_exit('')
        else:
            return super(AnglerShell, self).default(line)

    def do_exit(self, args):
        try:
            import readline
            last_index = readline.get_current_history_length()
            last_command = readline.get_history_item(last_index)
            if (last_command is not None and (last_command == 'exit'
                    or last_command.startswith('exit '))):
                readline.remove_history_item(last_index-1)
        except ImportError:
            pass
        return True

    def do_add(self, args):
        add = Add.from_arguments(self.manifest, args)
        if add is not None:
            add.run()

    def do_order(self, args):
        order = Order.from_arguments(self.manifest, args)
        if order is not None:
            order.run()

    def do_stub(self, args):
        print(args)

    def do_var(self, args):
        if not args:
            for key in sorted(self.environment):
                print('{}={!r}'.format(key, self.environment[key]))
            return
        key, successful, value = arg.partition('=')
        if successful:
            self.environment[key.strip()] = single_arg(value)
        else:
            key = arg.strip()
            print('{}={!r}'.format(key, self.environment[key]))

    def do_cd(self, args):
        self.environment['curdir'] = args[0]

    def do_ls(self, args):
        arg = (args[:0] or [self.environment['curdir']])[0]
        if not arg:
            for scheme in self.manifest.plugins:
                print('{}://'.format(scheme))
        else:
            print('Not Implemented!')

    def help_add(self):
        print(Add.help())


if __name__ == '__main__':

    parser = argparse.ArgumentParser()

    parser.add_argument('manifest', nargs='?', default=default_manifest)
    parser.add_argument('-n', '--dryrun', action='store_true')

    args = parser.parse_args()

    if not os.path.exists(args.manifest):
        setup(args.manifest)

    manifest = Manifest(args.manifest)

    try:
        shell = AnglerShell(manifest)
        shell.environment['dryrun'] = args.dryrun
        shell.cmdloop()
    except KeyboardInterrupt:
        print()
        exit(0)
